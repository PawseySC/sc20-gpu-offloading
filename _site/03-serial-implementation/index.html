<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="last-modified" content="2020-04-30 13:41:54 +0800">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- meta "search-domain" used for google site search function google_search() -->
    <meta name="search-domain" value="">
    <link rel="stylesheet" type="text/css" href="../assets/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/lesson.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/syntax.css" />
    
    <link rel="shortcut icon" type="image/x-icon" href="/favicon-swc.ico" />
    
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
	<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
	<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	<![endif]-->
    <title>Differences between OpenACC and OpenMP offloading models: Serial Implementation</title>
  </head>
  <body>
    <div class="container">
      
<nav class="navbar navbar-default">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      
      

      
      <a class="navbar-brand" href="../index.html">Home</a>

    </div>
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">

	
        <li><a href="../conduct/">Code of Conduct</a></li>

        
	
        <li><a href="../setup.html">Setup</a></li>

        
        <li class="dropdown">
          <a href="../" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Episodes <span class="caret"></span></a>
          <ul class="dropdown-menu">
            
            <li><a href="../01-talks/index.html">Talks</a></li>
            
            <li><a href="../02-laplace-introduction/index.html">Introduction to Laplace Equation</a></li>
            
            <li><a href="../03-serial-implementation/index.html">Serial Implementation</a></li>
            
            <li><a href="../04-profiling/index.html">Profiling</a></li>
            
            <li><a href="../05-loop-parallelisation/index.html">Loop parallelisation</a></li>
            
            <li><a href="../06-data-management/index.html">Data management</a></li>
            
<!--	    <li role="separator" class="divider"></li>
            <li><a href="../aio.html">All in one page (Beta)</a></li>
-->
          </ul>
        </li>
	
<!--
	
	
        <li class="dropdown">
          <a href="../" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Extras <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="../reference.html">Reference</a></li>
            
            <li><a href="../about/index.html">About</a></li>
            
            <li><a href="../discuss/index.html">Discussion</a></li>
            
            <li><a href="../figures/index.html">Figures</a></li>
            
            <li><a href="../guide/index.html">Instructor Notes</a></li>
            
          </ul>
        </li>
	
-->

	
        <li><a href="../LICENSE.html">License</a></li>
<!--	
	<li><a href="/edit/gh-pages/_episodes/03-serial-implementation.md">Improve this page <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span></a></li>
	
--> 
      </ul>
      <form class="navbar-form navbar-right" role="search" id="search" onsubmit="google_search(); return false;">
        <div class="form-group">
          <input type="text" id="google-search" placeholder="Search..." aria-label="Google site search">
        </div>
      </form>
    </div>
  </div>
</nav>


<div class="row">
  <div class="col-xs-1">
    <h3 class="text-left">
      
      <a href="../02-laplace-introduction/index.html"><span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span><span class="sr-only">previous episode</span></a>
      
    </h3>
  </div>
  <div class="col-xs-10">
    
    <h3 class="maintitle"><a href="../">Differences between OpenACC and OpenMP offloading models</a></h3>
    
  </div>
  <div class="col-xs-1">
    <h3 class="text-right">
      
      <a href="../04-profiling/index.html"><span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span><span class="sr-only">next episode</span></a>
      
    </h3>
  </div>
</div>

<article>
<div class="row">
  <div class="col-md-1">
  </div>
  <div class="col-md-10">
    <h1 class="maintitle">Serial Implementation</h1>
  </div>
  <div class="col-md-1">
  </div>
</div>


<blockquote class="objectives">
  <h2>Overview</h2>

  <div class="row">
    <div class="col-md-3">
      <strong>Teaching:</strong> 15 min
      <br/>
      <strong>Exercises:</strong> 0 min
    </div>
    <div class="col-md-9">
      <strong>Questions</strong>
      <ul>
	
	<li><p>A quick overview of the serial implementation of a 2D Laplace equation solver</p>
</li>
	
      </ul>
    </div>
  </div>

  <div class="row">
    <div class="col-md-3">
    </div>
    <div class="col-md-9">
      <strong>Objectives</strong>
      <ul>
	
	<li><p>Understand data structures used in the implementation</p>
</li>
	
	<li><p>Understand code structure and functions defined in the code</p>
</li>
	
      </ul>
    </div>
  </div>

</blockquote>

<h1 id="serial-implementation">Serial implementation</h1>
<h2 id="code-structure">Code structure</h2>
<h3 id="data-structures">Data structures</h3>
<p>The number of grid nodes in each direction of the 2D grid is defined at the top of the file as:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// grid size</span>
<span class="cp">#define GRIDY    2048
#define GRIDX    2048
</span></code></pre></div></div>

<p>The main data structures used in the code are two 2D double precision arrays representing temperature grids from current and previous iterations.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">double</span> <span class="n">T_new</span><span class="p">[</span><span class="n">GRIDX</span><span class="o">+</span><span class="mi">2</span><span class="p">][</span><span class="n">GRIDY</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span> <span class="c1">// temperature grid</span>
<span class="kt">double</span> <span class="n">T</span><span class="p">[</span><span class="n">GRIDX</span><span class="o">+</span><span class="mi">2</span><span class="p">][</span><span class="n">GRIDY</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span>     <span class="c1">// temperature grid from last iteration</span>
</code></pre></div></div>
<p>The size of those arrays in each direction is equal to the number of grid nodes in that direction plus 2. The additional padding is used to allow for computation of boundary elements.</p>

<h3 id="functions">Functions</h3>
<p>There are two functions defined in the code:</p>
<ul>
  <li>initialisation function <code class="highlighter-rouge">init()</code> which sets the initial and boundary condition,</li>
  <li>main function <code class="highlighter-rouge">main(int argc, char *argv[])</code> which reads code input parameters, calls the initialisation function and implements the main algorithm.</li>
</ul>

<h2 id="initialisation-function">Initialisation function</h2>
<p>The initialisation function sets the initial condition to 0 in every grid node.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">GRIDX</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">GRIDY</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">){</span>
            <span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>The initialisation function also sets the boundary conditions of the grid to have the value 0 for the row/column where the first/second index are zero. Along the other two boundaries the temperature will increase linearly from 0 to 128.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1">// set left side to 0 and right to a linear increase</span>
    <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">GRIDX</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
        <span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">GRIDY</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">128</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="n">GRIDX</span><span class="p">)</span><span class="o">*</span><span class="n">i</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// set top to 0 and bottom to linear increase</span>
    <span class="k">for</span><span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">GRIDY</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
        <span class="n">T</span><span class="p">[</span><span class="n">GRIDX</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">128</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="n">GRIDY</span><span class="p">)</span><span class="o">*</span><span class="n">j</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<h2 id="main-functions">Main functions</h2>

<p>The most important part of the main function is the implementation of Laplace equation solver. The algorithm iterations are implemented as a <code class="highlighter-rouge">while</code> loop. The <code class="highlighter-rouge">while</code> loop will terminate when one of the following conditions are satisfied:</p>
<ul>
  <li>the number of iterations <code class="highlighter-rouge">iteration</code> exceeds the maximum number of iterations <code class="highlighter-rouge">max_iteration</code> defined by the user as a command line parameter,</li>
  <li>the largest change in temperature <code class="highlighter-rouge">from the previous iteration </code><code class="highlighter-rouge">dt</code><code class="highlighter-rouge"> is lower than </code><code class="highlighter-rouge">MAX_TEMP_ERROR</code>`.</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// simulation iterations</span>
<span class="k">while</span> <span class="p">(</span> <span class="n">dt</span> <span class="o">&gt;</span> <span class="n">MAX_TEMP_ERROR</span> <span class="o">&amp;&amp;</span> <span class="n">iteration</span> <span class="o">&lt;=</span> <span class="n">max_iterations</span> <span class="p">)</span> <span class="p">{</span>
</code></pre></div></div>

<p>Within the <code class="highlighter-rouge">while</code> loop the main computational kernel is implemented. The new temperature for every grid node is computed as an average over neighbours in the grid.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
    <span class="c1">// main computational kernel, average over neighbours in the grid</span>
    <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">GRIDX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="k">for</span><span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">GRIDY</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
            <span class="n">T_new</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">25</span> <span class="o">*</span> <span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span>
                                        <span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]);</span>
</code></pre></div></div>
<p>Next, the largest change in the temperature is computed and <code class="highlighter-rouge">dt</code> is updated. <code class="highlighter-rouge">T_new</code> is copied to <code class="highlighter-rouge">T</code> to allow for update in the next iteration. Diagnostic information is periodically printed (every 100 iterations) to monitor the convergence of the iterative algorithm.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1">// reset dt</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

    <span class="c1">// compute the largest change and copy T_new to T</span>
    <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">GRIDX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="k">for</span><span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">GRIDY</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">){</span>
          <span class="n">dt</span> <span class="o">=</span> <span class="n">MAX</span><span class="p">(</span> <span class="n">fabs</span><span class="p">(</span><span class="n">T_new</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]),</span> <span class="n">dt</span><span class="p">);</span>
          <span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_new</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// periodically print largest change</span>
    <span class="k">if</span><span class="p">((</span><span class="n">iteration</span> <span class="o">%</span> <span class="mi">100</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Iteration %4.0d, dt %f</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">iteration</span><span class="p">,</span><span class="n">dt</span><span class="p">);</span>

    <span class="n">iteration</span><span class="o">++</span><span class="p">;</span>
</code></pre></div></div>
<h2 id="time-measurements">Time measurements</h2>

<p>The execution time of the algorithm is measured and reported with the use of <em>gettimeofday</em> function.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start_time</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
<span class="p">...</span>    
<span class="n">gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stop_time</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
<span class="n">timersub</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stop_time</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start_time</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">elapsed_time</span><span class="p">);</span> <span class="c1">// measure time</span>

<span class="n">printf</span><span class="p">(</span><span class="s">"Total time was %f seconds.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">elapsed_time</span><span class="p">.</span><span class="n">tv_sec</span><span class="o">+</span><span class="n">elapsed_time</span><span class="p">.</span><span class="n">tv_usec</span><span class="o">/</span><span class="mi">1000000</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span>
</code></pre></div></div>


<blockquote class="keypoints">
  <h2>Key Points</h2>
  <ul>
    
    <li><p>2D Laplace equation solver is easy to implement. In the implementation we are using basic programming constructs like while and for loops.</p>
</li>
    
  </ul>
</blockquote>

</article>

<div class="row">
  <div class="col-xs-1">
    <h3 class="text-left">
      
      <a href="../02-laplace-introduction/index.html"><span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span><span class="sr-only">previous episode</span></a>
      
    </h3>
  </div>
  <div class="col-xs-10">
    
  </div>
  <div class="col-xs-1">
    <h3 class="text-right">
      
      <a href="../04-profiling/index.html"><span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span><span class="sr-only">next episode</span></a>
      
    </h3>
  </div>
</div>


      
      	
<footer>
  <div class="row">
    <div class="col-md-6" align="left">
      <h4>
	Copyright &copy; 2016â€“2020
	<a href="http://pawsey.org.au">Pawsey Supercomputing Centre</a>

      </h4>
    </div>
    <div class="col-md-6" align="right">
      <h4>

	Adapted from <a href="http://software-carpentry.org">Software Carpentry</a>
	/
	<a href="mailto:mailto:help@pawsey.org.au">Contact</a>
      </h4>
    </div>
  </div>
</footer>

      
    </div>
    
<script src="../assets/js/jquery.min.js"></script>
<script src="../assets/js/bootstrap.min.js"></script>
<script src="../assets/js/lesson.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-37305346-2', 'auto');
  ga('send', 'pageview');
</script>

  </body>
</html>
